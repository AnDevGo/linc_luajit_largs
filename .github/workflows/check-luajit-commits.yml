name: Check for LuaJIT Commits
on:
  schedule:
    - cron: 0 0 * * *
jobs:
  Job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Get last fetched commit SHA
        id: get_last_commit
        run: 'echo "::set-output name=last_commit::$(cat last_commit.txt)"'

      - name: Check for LuaJIT commits
        id: luajit_commits
        run: |
          repository="LuaJIT/LuaJIT"
          token=$GITHUB_TOKEN
          last_commit=${{ steps.get_last_commit.outputs.last_commit }}
          curl -s -H "Authorization: token $token" "https://api.github.com/repos/$repository/commits?since=$last_commit" > luajit_commits.json
          echo "::set-output name=commit_count::$(jq '. | length' luajit_commits.json)"

      - name: Trigger build workflow if new LuaJIT commits found
        if: steps.luajit_commits.outputs.commit_count > 0
        run: |
          echo "New LuaJIT commits found. Triggering the build workflow."
          curl -X POST -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/MAJigsaw77/hxluajit/actions/workflows/luajit-build.yml/dispatches" -d '{"ref":"main"}'
